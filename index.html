<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planeamento Semanal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
    select, button { padding: 6px; font-size: 16px; }
    .day-block { margin-bottom: 20px; padding: 15px; border-radius: 10px; background: white; box-shadow: 0 0 10px #ccc; }
    .today { background-color: #d0f0c0; }
    .tomorrow { background-color: #fff4b2; }
    .service { padding: 5px 0; border-bottom: 1px solid #eee; font-size: 15px; }
    .date-title { font-weight: bold; margin-bottom: 8px; font-size: 18px; }
    @media (max-width: 600px) {
      .controls { flex-direction: column; align-items: flex-start; }
      select, button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="controls">
    <label>Motorista:
      <select id="motoristaSelect" onchange="carregarPlaneamento()"></select>
    </label>
    <button onclick="alterarSemana(-1)">‚Üê Semana Anterior</button>
    <button onclick="alterarSemana(0)">Semana Atual</button>
    <button onclick="alterarSemana(1)">Semana Seguinte ‚Üí</button>
    <button onclick="carregarPlaneamento()">üîÑ Atualizar</button>
  </div>

  <div id="planeamento">A carregar...</div>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbwBQWGNHjTC5lf-yDuDquV6tbauaUm01tnVKnQ0Gvb1OVrkehXklqwZjrVGPigFZqM1/exec";
    let semanaOffset = 0;
    let motoristasDisponiveis = [];

    function alterarSemana(offset) {
      semanaOffset = offset;
      inicializarMotoristas();
    }

    async function inicializarMotoristas() {
      const container = document.getElementById("planeamento");
      container.innerHTML = "A carregar motoristas...";

      const url = `${endpoint}?semana=${semanaOffset}`; // sem motorista
      try {
        const res = await fetch(url);
        const data = await res.json();
        motoristasDisponiveis = [...new Set(Object.values(data).flat().map(s => s["MOTORISTA"]))];

        const select = document.getElementById("motoristaSelect");
        select.innerHTML = "";
        if (motoristasDisponiveis.length === 0) {
          container.innerHTML = "Nenhum motorista encontrado.";
          return;
        }

        motoristasDisponiveis.forEach(nome => {
          const opt = document.createElement("option");
          opt.value = nome;
          opt.textContent = nome;
          select.appendChild(opt);
        });

        select.value = motoristasDisponiveis[0];
        carregarPlaneamento();
      } catch (err) {
        container.innerHTML = "Erro ao carregar motoristas.";
        console.error(err);
      }
    }

    async function carregarPlaneamento() {
      const motorista = document.getElementById("motoristaSelect").value;
      const container = document.getElementById("planeamento");
      container.innerHTML = "A carregar planeamento...";

      const url = `${endpoint}?motorista=${encodeURIComponent(motorista)}&semana=${semanaOffset}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        renderizarPlaneamento(data);
      } catch (err) {
        container.innerHTML = "Erro ao carregar dados.";
        console.error(err);
      }
    }

function renderizarPlaneamento(data) {
  const container = document.getElementById("planeamento");
  container.innerHTML = "";

  // Criar lista fixa da semana: segunda a domingo da semana selecionada
  const hoje = new Date();
  const base = new Date(hoje);
  base.setDate(base.getDate() + semanaOffset * 7);
  const day = base.getDay();
  // Ajusta para segunda-feira
  const diffToMonday = day === 0 ? -6 : 1 - day;
  const monday = new Date(base);
  monday.setDate(base.getDate() + diffToMonday);

  const diasSemana = [];
  for(let i=0; i<7; i++) {
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    diasSemana.push(d);
  }

  const hojeStr = hoje.toISOString().split('T')[0];
  const amanhaStr = new Date(Date.now() + 86400000).toISOString().split('T')[0];

  diasSemana.forEach(dia => {
    const dataKey = dia.toISOString().split('T')[0];
    const dayDiv = document.createElement("div");
    dayDiv.className = "day-block";

    if (dataKey === hojeStr) dayDiv.classList.add("today");
    if (dataKey === amanhaStr) dayDiv.classList.add("tomorrow");

    const dateTitle = document.createElement("div");
    dateTitle.className = "date-title";
    dateTitle.textContent = dia.toLocaleDateString("pt-PT", {
      weekday: 'long', day: '2-digit', month: 'short'
    });
    dayDiv.appendChild(dateTitle);

    const servicos = data[dataKey] || [];
    if (servicos.length === 0) {
      const vazio = document.createElement("div");
      vazio.textContent = "Nenhum servi√ßo.";
      vazio.style.fontStyle = "italic";
      dayDiv.appendChild(vazio);
    } else {
      servicos.forEach(servico => {
        const servDiv = document.createElement("div");
        servDiv.className = "service";

        // Linha 1: servi√ßo carga ‚Üí servi√ßo descarga
        const linha1 = document.createElement("div");
        linha1.textContent = `${servico["SERVI√áO CARGA"] || ""} ‚Üí ${servico["SERVI√áO DESCARGA"] || ""}`;
        servDiv.appendChild(linha1);

        // Linha 2: Viatura e Reboque juntos
        const linha2 = document.createElement("div");
        linha2.textContent = `Viatura: ${servico["VIATURA"] || "-"}, Reboque: ${servico["REBOQUE"] || "-"}`;
        servDiv.appendChild(linha2);

        // Linha 3+: NEI, Res√≠duo, Observa√ß√µes (se existirem)
        if (servico["NEI"]) {
          const nei = document.createElement("div");
          nei.textContent = `NEI: ${servico["NEI"]}`;
          servDiv.appendChild(nei);
        }
        if (servico["RES√çDUO"]) {
          const res = document.createElement("div");
          res.textContent = `Res√≠duo: ${servico["RES√çDUO"]}`;
          servDiv.appendChild(res);
        }
        if (servico["OBSERVA√á√ïES"]) {
          const obs = document.createElement("div");
          obs.textContent = `Observa√ß√µes: ${servico["OBSERVA√á√ïES"]}`;
          servDiv.appendChild(obs);
        }

        dayDiv.appendChild(servDiv);
      });
    }

    container.appendChild(dayDiv);
  });
}

      datas.forEach(dataKey => {
        const dayDiv = document.createElement("div");
        dayDiv.className = "day-block";
        if (dataKey === hoje) dayDiv.classList.add("today");
        if (dataKey === amanha) dayDiv.classList.add("tomorrow");

        const dateTitle = document.createElement("div");
        dateTitle.className = "date-title";
        dateTitle.textContent = new Date(dataKey).toLocaleDateString("pt-PT", {
          weekday: 'long', day: '2-digit', month: 'short'
        });
        dayDiv.appendChild(dateTitle);

        data[dataKey].forEach(servico => {
          const s = document.createElement("div");
          s.className = "service";
          s.textContent =
            `${servico["SERVI√áO CARGA"] || ""} ‚Üí ${servico["SERVI√áO DESCARGA"] || ""} | ` +
            `Viatura: ${servico["VIATURA"] || "-"}, Reboque: ${servico["REBOQUE"] || "-"}` +
            (servico["NEI"] ? ` | NEI: ${servico["NEI"]}` : "") +
            (servico["RES√çDUO"] ? ` | Res√≠duo: ${servico["RES√çDUO"]}` : "") +
            (servico["OBSERVA√á√ïES"] ? ` | Obs: ${servico["OBSERVA√á√ïES"]}` : "");
          dayDiv.appendChild(s);
        });

        container.appendChild(dayDiv);
      });
    }

    inicializarMotoristas(); // corre ao carregar a p√°gina
  </script>
</body>
</html>
