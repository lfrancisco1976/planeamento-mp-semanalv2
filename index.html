<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planeamento Semanal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
    select, button { padding: 6px; font-size: 16px; }
    .day-block { margin-bottom: 20px; padding: 15px; border-radius: 10px; background: white; box-shadow: 0 0 10px #ccc; }
    .today { background-color: #d0f0c0; }
    .tomorrow { background-color: #fff4b2; }
    .service { padding: 5px 0; border-bottom: 1px solid #eee; font-size: 15px; }
    .date-title { font-weight: bold; margin-bottom: 8px; font-size: 18px; }
    @media (max-width: 600px) {
      .controls { flex-direction: column; align-items: flex-start; }
      select, button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="controls">
    <label>Motorista:
      <select id="motoristaSelect"></select>
    </label>
    <button onclick="alterarSemana(-1)">‚Üê Semana Anterior</button>
    <button onclick="alterarSemana(0)">Semana Atual</button>
    <button onclick="alterarSemana(1)">Semana Seguinte ‚Üí</button>
    <button onclick="carregarPlaneamento()">üîÑ Atualizar</button>
  </div>

  <div id="planeamento">A carregar...</div>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbwBQWGNHjTC5lf-yDuDquV6tbauaUm01tnVKnQ0Gvb1OVrkehXklqwZjrVGPigFZqM1/exec";
    let semanaOffset = 0;
    let motoristasDisponiveis = [];

    function alterarSemana(offset) {
      semanaOffset = offset;
      carregarPlaneamento();
    }

    async function carregarPlaneamento() {
      const motorista = document.getElementById("motoristaSelect").value;
      const container = document.getElementById("planeamento");
      container.innerHTML = "A carregar...";

      const url = `${endpoint}?motorista=${encodeURIComponent(motorista)}&semana=${semanaOffset}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        atualizarListaMotoristas(data);
        renderizarPlaneamento(data);
      } catch (err) {
        container.innerHTML = "Erro ao carregar dados.";
        console.error(err);
      }
    }

    function atualizarListaMotoristas(data) {
      const motoristasUnicos = new Set();
      Object.values(data).flat().forEach(s => {
        if (s["MOTORISTA"]) motoristasUnicos.add(s["MOTORISTA"]);
      });

      const select = document.getElementById("motoristaSelect");
      const anterior = select.value;
      select.innerHTML = "";

      motoristasUnicos.forEach(nome => {
        const opt = document.createElement("option");
        opt.value = nome;
        opt.textContent = nome;
        select.appendChild(opt);
      });

      // Repor sele√ß√£o anterior se poss√≠vel, ou usar primeiro
      if (motoristasUnicos.size > 0) {
        select.value = anterior && motoristasUnicos.has(anterior) ? anterior : [...motoristasUnicos][0];
      }
    }

    function renderizarPlaneamento(data) {
      const container = document.getElementById("planeamento");
      container.innerHTML = "";

      const hoje = new Date().toISOString().split('T')[0];
      const amanha = new Date(Date.now() + 86400000).toISOString().split('T')[0];

      const datas = Object.keys(data).sort();
      if (datas.length === 0) {
        container.innerHTML = "<p>Nenhum servi√ßo encontrado para esta semana.</p>";
        return;
      }

      datas.forEach(dataKey => {
        const dayDiv = document.createElement("div");
        dayDiv.className = "day-block";
        if (dataKey === hoje) dayDiv.classList.add("today");
        if (dataKey === amanha) dayDiv.classList.add("tomorrow");

        const dateTitle = document.createElement("div");
        dateTitle.className = "date-title";
        dateTitle.textContent = new Date(dataKey).toLocaleDateString("pt-PT", {
          weekday: 'long', day: '2-digit', month: 'short'
        });
        dayDiv.appendChild(dateTitle);

        data[dataKey].forEach(servico => {
          const s = document.createElement("div");
          s.className = "service";
          s.textContent =
            `${servico["SERVI√áO CARGA"] || ""} ‚Üí ${servico["SERVI√áO DESCARGA"] || ""} | ` +
            `Viatura: ${servico["VIATURA"] || "-"}, Reboque: ${servico["REBOQUE"] || "-"}` +
            (servico["NEI"] ? ` | NEI: ${servico["NEI"]}` : "") +
            (servico["RES√çDUO"] ? ` | Res√≠duo: ${servico["RES√çDUO"]}` : "") +
            (servico["OBSERVA√á√ïES"] ? ` | Obs: ${servico["OBSERVA√á√ïES"]}` : "");
          dayDiv.appendChild(s);
        });

        container.appendChild(dayDiv);
      });
    }

    carregarPlaneamento();
  </script>
</body>
</html>
